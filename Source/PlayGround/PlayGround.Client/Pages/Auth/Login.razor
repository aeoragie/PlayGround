@page "/auth/login"
@layout MainLayout
@inject Services.AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>로그인 — PlayGround</PageTitle>

<AuthLayout Variant="AuthLayout.AuthVariant.LoginRegister">

    @* 헤더 *@
    <div class="mb-6">
        <h1 class="@Css.Typography.PageTitle">로그인</h1>
        <p class="@Css.Typography.PageSubtitle">소셜 계정 또는 이메일로 시작하세요.</p>
    </div>

    @* 탭 *@
    <AuthTabs IsLoginActive="true" />

    @* 소셜 로그인 *@
    <SocialLoginButtons ShowAll="true" ActionText="계속하기" />

    @* 구분선 *@
    <div class="@Css.Divider.Container">
        <div class="@Css.Divider.Line"></div>
        <span class="@Css.Divider.Text">또는 이메일</span>
        <div class="@Css.Divider.Line"></div>
    </div>

    @* 에러 메시지 *@
    @if (!string.IsNullOrEmpty(mErrorMessage))
    {
        <div class="@Css.Alert.Error">
            @mErrorMessage
        </div>
    }

    @* 이메일 *@
    <div class="@Css.Form.FieldGroup">
        <label class="@Css.Form.Label">이메일</label>
        <input type="email" class="auth-input" placeholder="email@example.com"
               @bind="mEmail" @bind:event="oninput" />
    </div>

    @* 비밀번호 *@
    <div class="@Css.Form.FieldGroup">
        <label class="@Css.Form.Label">비밀번호</label>
        <input type="password" class="auth-input" placeholder="8자 이상"
               @bind="mPassword" @bind:event="oninput"
               @onkeydown="HandleKeyDown" />
    </div>

    @* 기억하기 + 비밀번호 찾기 *@
    <div class="@Css.Form.Row">
        <label class="@Css.Form.CheckLabel">
            <input type="checkbox" @bind="mRememberMe" class="accent-navy" />
            로그인 상태 유지
        </label>
        <a href="/auth/forgot-password" class="text-xs font-semibold text-navy no-underline hover:text-primary transition-colors">
            비밀번호 찾기
        </a>
    </div>

    @* 제출 *@
    <button class="btn-auth-submit" @onclick="HandleLogin" disabled="@mIsLoading">
        @(mIsLoading ? "로그인 중..." : "로그인")
    </button>

    @* 푸터 *@
    <div class="@Css.Typography.FooterNote">
        계정이 없으신가요?
        <a href="/auth/register" class="@Css.Link.Navy">회원가입</a>
    </div>

</AuthLayout>

@code {
    private string mEmail = string.Empty;
    private string mPassword = string.Empty;
    private bool mRememberMe;
    private bool mIsLoading;
    private string? mErrorMessage;

    private async Task HandleLogin()
    {
        mErrorMessage = null;

        if (string.IsNullOrWhiteSpace(mEmail) || string.IsNullOrWhiteSpace(mPassword))
        {
            mErrorMessage = "이메일과 비밀번호를 입력해주세요.";
            return;
        }

        mIsLoading = true;

        try
        {
            var result = await AuthService.LoginAsync(mEmail, mPassword);
            if (result.IsSuccess)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                mErrorMessage = string.IsNullOrEmpty(result.Message) ? "로그인에 실패했습니다." : result.Message;
            }
        }
        catch
        {
            mErrorMessage = "서버와 통신할 수 없습니다.";
        }
        finally
        {
            mIsLoading = false;
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await HandleLogin();
        }
    }

}
