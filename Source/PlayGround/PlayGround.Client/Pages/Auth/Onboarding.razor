@page "/auth/onboarding"
@layout MainLayout
@inject Services.AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>프로필 설정 — PlayGround</PageTitle>

<AuthLayout Variant="AuthLayout.AuthVariant.Onboarding">

    @* 헤더 *@
    <div class="mb-6">
        <h1 class="@Css.Auth.PageTitle">프로필 설정</h1>
        <p class="@Css.Auth.PageSubtitle">몇 가지 정보만 알려주시면 맞춤 경험을 준비합니다.</p>
    </div>

    @* 단계 표시 *@
    <StepIndicator CurrentStep="2" TotalSteps="3" />

    @* 자녀 이름 *@
    <div class="@Css.Form.FieldGroup">
        <label class="@Css.Form.Label">자녀 이름 (닉네임)</label>
        <input type="text" class="auth-input" placeholder="자녀의 이름 또는 닉네임"
               @bind="mChildName" @bind:event="oninput" />
    </div>

    @* 종목 + 연령대 (2열) *@
    <div class="grid grid-cols-2 gap-2.5 mb-3.5">
        <div>
            <label class="@Css.Form.Label">종목</label>
            <select class="auth-select" @bind="mSportType">
                <option value="">선택</option>
                <option value="Soccer" selected>축구</option>
                <option value="Baseball">야구</option>
                <option value="Basketball">농구</option>
            </select>
        </div>
        <div>
            <label class="@Css.Form.Label">연령대</label>
            <select class="auth-select" @bind="mAgeGroup">
                <option value="">선택</option>
                <option value="U10">U10 (초등 저학년)</option>
                <option value="U12">U12 (초등 고학년)</option>
                <option value="U15">U15 (중학생)</option>
                <option value="U18">U18 (고등학생)</option>
            </select>
        </div>
    </div>

    @* 활동 지역 *@
    <div class="@Css.Form.FieldGroup">
        <label class="@Css.Form.Label">활동 지역</label>
        <select class="auth-select" @bind="mRegion">
            <option value="">선택</option>
            <option value="서울">서울</option>
            <option value="경기">경기</option>
            <option value="인천">인천</option>
            <option value="부산">부산</option>
            <option value="대구">대구</option>
            <option value="대전">대전</option>
            <option value="광주">광주</option>
            <option value="울산">울산</option>
            <option value="세종">세종</option>
            <option value="강원">강원</option>
            <option value="충북">충북</option>
            <option value="충남">충남</option>
            <option value="전북">전북</option>
            <option value="전남">전남</option>
            <option value="경북">경북</option>
            <option value="경남">경남</option>
            <option value="제주">제주</option>
        </select>
    </div>

    @* 현재 소속 팀 *@
    <div class="@Css.Form.FieldGroup">
        <label class="@Css.Form.Label">현재 소속 팀 (선택)</label>
        <input type="text" class="auth-input" placeholder="팀 이름으로 검색"
               @bind="mTeamName" @bind:event="oninput" />
        <div class="@Css.Badge.Optional mt-2">
            나중에 설정에서 추가할 수 있습니다
        </div>
    </div>

    @* 에러 메시지 *@
    @if (!string.IsNullOrEmpty(mErrorMessage))
    {
        <div class="@Css.Alert.Error">
            @mErrorMessage
        </div>
    }

    @* 제출 *@
    <button class="btn-auth-submit" @onclick="HandleComplete" disabled="@mIsLoading">
        @(mIsLoading ? "저장 중..." : "프로필 완성하기")
    </button>

    @* 스킵 *@
    <div class="@Css.Auth.SkipLink"
         @onclick="HandleSkip">
        나중에 입력할게요 &rarr;
    </div>

</AuthLayout>

@code {
    private string mChildName = string.Empty;
    private string mSportType = "Soccer";
    private string mAgeGroup = string.Empty;
    private string mRegion = string.Empty;
    private string mTeamName = string.Empty;
    private bool mIsLoading;
    private string? mErrorMessage;

    private async Task HandleComplete()
    {
        mErrorMessage = null;
        mIsLoading = true;

        try
        {
            var result = await AuthService.SaveOnboardingAsync(mChildName, mSportType, mAgeGroup, mRegion, mTeamName);
            if (result.IsSuccess)
            {
                Navigation.NavigateTo("/auth/complete");
            }
            else
            {
                mErrorMessage = result.Message ?? "프로필 저장에 실패했습니다.";
            }
        }
        catch
        {
            mErrorMessage = "서버와 통신할 수 없습니다.";
        }
        finally
        {
            mIsLoading = false;
        }
    }

    private void HandleSkip()
    {
        Navigation.NavigateTo("/auth/complete");
    }
}
