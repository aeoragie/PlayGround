@page "/auth/social-callback"
@layout MainLayout
@inject Services.AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>로그인 중... — PlayGround</PageTitle>

<AuthLayout Variant="AuthLayout.AuthVariant.LoginRegister">

    @if (!string.IsNullOrEmpty(mErrorMessage))
    {
        <div class="text-center">
            <h1 class="text-xl font-bold text-navy mb-3">로그인 실패</h1>
            <div class="px-3.5 py-2.5 rounded-btn text-xs font-semibold mb-4
                        bg-red-50 text-red-600 border border-red-200">
                @mErrorMessage
            </div>
            <a href="/auth/login" class="btn-auth-submit block text-center no-underline">
                로그인 페이지로 돌아가기
            </a>
        </div>
    }
    else
    {
        <div class="text-center py-10">
            <h1 class="text-xl font-bold text-navy mb-3">로그인 중...</h1>
            <p class="text-[13px] text-text-secondary">잠시만 기다려주세요.</p>
        </div>
    }

</AuthLayout>

@code {
    private string? mErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);

        var error = query["error"];
        var success = query["success"];

        if (!string.IsNullOrWhiteSpace(error))
        {
            mErrorMessage = error switch
            {
                "NoCode" => "인증 코드를 받지 못했습니다.",
                "ProviderError" => "소셜 로그인 제공자에서 오류가 발생했습니다.",
                _ => error
            };
            return;
        }

        if (success == "true")
        {
            // RefreshToken 쿠키로 AccessToken 갱신
            var refreshed = await AuthService.TryRefreshTokenAsync();

            if (refreshed)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                mErrorMessage = "세션을 생성할 수 없습니다. 다시 시도해주세요.";
            }
        }
        else
        {
            mErrorMessage = "알 수 없는 오류가 발생했습니다.";
        }
    }
}
