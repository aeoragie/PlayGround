@page "/auth/verify-email"
@layout MainLayout
@inject Services.AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>이메일 인증 — PlayGround</PageTitle>

<AuthLayout Variant="AuthLayout.AuthVariant.Onboarding">

    @* 헤더 *@
    <div class="mb-6">
        <h1 class="text-xl font-bold text-navy mb-1">이메일 인증</h1>
        <p class="text-[13px] text-text-secondary">
            @if (!string.IsNullOrEmpty(mEmail))
            {
                <span>@mEmail 으로 발송된 6자리 코드를 입력해주세요.</span>
            }
            else
            {
                <span>이메일 주소를 입력하고 인증 코드를 받으세요.</span>
            }
        </p>
    </div>

    @* 단계 표시 *@
    <StepIndicator CurrentStep="1" TotalSteps="3" />

    @* 이메일 입력 (코드 발송 전) *@
    @if (!mCodeSent)
    {
        <div class="mb-3.5">
            <label class="block text-xs font-semibold text-slate mb-1.5">이메일</label>
            <input type="email" class="auth-input" placeholder="email@example.com"
                   @bind="mEmail" @bind:event="oninput" />
        </div>
    }

    @* 인증 코드 입력 (코드 발송 후) *@
    @if (mCodeSent)
    {
        <div class="mb-3.5">
            <label class="block text-xs font-semibold text-slate mb-1.5">인증 코드</label>
            <input type="text" class="auth-input text-center tracking-[0.3em] text-lg font-bold"
                   placeholder="000000" maxlength="6"
                   @bind="mCode" @bind:event="oninput" />
        </div>
    }

    @* 에러 메시지 *@
    @if (!string.IsNullOrEmpty(mErrorMessage))
    {
        <div class="px-3.5 py-2.5 rounded-btn text-xs font-semibold mb-4
                    bg-red-50 text-red-600 border border-red-200">
            @mErrorMessage
        </div>
    }

    @* 성공 메시지 *@
    @if (!string.IsNullOrEmpty(mSuccessMessage))
    {
        <div class="px-3.5 py-2.5 rounded-btn text-xs font-semibold mb-4
                    bg-green-50 text-green-600 border border-green-200">
            @mSuccessMessage
        </div>
    }

    @* 제출 버튼 *@
    @if (!mCodeSent)
    {
        <button class="btn-auth-submit" @onclick="HandleSendCode" disabled="@mIsLoading">
            @(mIsLoading ? "발송 중..." : "인증 코드 받기")
        </button>
    }
    else
    {
        <button class="btn-auth-submit" @onclick="HandleVerify" disabled="@mIsLoading">
            @(mIsLoading ? "확인 중..." : "인증 완료")
        </button>

        @* 재발송 *@
        <div class="block text-center text-xs text-text-light mt-2.5 cursor-pointer
                    hover:text-text-secondary transition-colors"
             @onclick="HandleResend">
            코드를 받지 못했나요? <span class="text-navy font-semibold">재발송</span>
        </div>
    }

    @* 스킵 *@
    <div class="block text-center text-xs text-text-light mt-2.5 cursor-pointer
                hover:text-text-secondary transition-colors"
         @onclick="HandleSkip">
        나중에 인증할게요 &rarr;
    </div>

</AuthLayout>

@code {
    private string mEmail = string.Empty;
    private string mCode = string.Empty;
    private bool mCodeSent;
    private bool mIsLoading;
    private string? mErrorMessage;
    private string? mSuccessMessage;
    private Guid mVerificationId;

    protected override void OnInitialized()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var email = query["email"];

        if (!string.IsNullOrWhiteSpace(email))
        {
            mEmail = email;
        }
    }

    private async Task HandleSendCode()
    {
        mErrorMessage = null;
        mSuccessMessage = null;

        if (string.IsNullOrWhiteSpace(mEmail))
        {
            mErrorMessage = "이메일을 입력해주세요.";
            return;
        }

        mIsLoading = true;

        try
        {
            var result = await AuthService.SendVerificationAsync(mEmail, "SignUp");

            if (result.IsSuccess && result.Data != null)
            {
                mVerificationId = result.Data.VerificationId;
                mCodeSent = true;
                mSuccessMessage = "인증 코드가 발송되었습니다.";
            }
            else
            {
                mErrorMessage = result.Error ?? "인증 코드 발송에 실패했습니다.";
            }
        }
        catch
        {
            mErrorMessage = "서버와 통신할 수 없습니다.";
        }
        finally
        {
            mIsLoading = false;
        }
    }

    private async Task HandleVerify()
    {
        mErrorMessage = null;
        mSuccessMessage = null;

        if (string.IsNullOrWhiteSpace(mCode) || mCode.Length != 6)
        {
            mErrorMessage = "6자리 인증 코드를 입력해주세요.";
            return;
        }

        mIsLoading = true;

        try
        {
            var result = await AuthService.VerifyEmailAsync(mVerificationId, mCode);

            if (result.IsSuccess)
            {
                Navigation.NavigateTo("/auth/onboarding");
            }
            else
            {
                mErrorMessage = result.Error ?? "인증 코드가 올바르지 않습니다.";
            }
        }
        catch
        {
            mErrorMessage = "서버와 통신할 수 없습니다.";
        }
        finally
        {
            mIsLoading = false;
        }
    }

    private async Task HandleResend()
    {
        mCode = string.Empty;
        mErrorMessage = null;
        mSuccessMessage = null;

        await HandleSendCode();
    }

    private void HandleSkip()
    {
        Navigation.NavigateTo("/auth/onboarding");
    }
}
