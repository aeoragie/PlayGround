@page "/auth/reset-password"
@layout MainLayout
@inject Services.AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>비밀번호 재설정 — PlayGround</PageTitle>

<AuthLayout Variant="AuthLayout.AuthVariant.LoginRegister">

    @* 헤더 *@
    <div class="mb-6">
        <h1 class="text-xl font-bold text-navy mb-1">비밀번호 재설정</h1>
        <p class="text-[13px] text-text-secondary">새로운 비밀번호를 입력해주세요.</p>
    </div>

    @* 에러 메시지 *@
    @if (!string.IsNullOrEmpty(mErrorMessage))
    {
        <div class="px-3.5 py-2.5 rounded-btn text-xs font-semibold mb-4
                    bg-red-50 text-red-600 border border-red-200">
            @mErrorMessage
        </div>
    }

    @* 성공 메시지 *@
    @if (mReset)
    {
        <div class="px-3.5 py-2.5 rounded-btn text-xs font-semibold mb-4
                    bg-green-50 text-green-600 border border-green-200">
            비밀번호가 변경되었습니다. 새 비밀번호로 로그인해주세요.
        </div>

        <a href="/auth/login" class="btn-auth-submit block text-center no-underline">
            로그인하기
        </a>
    }
    else
    {
        @* 새 비밀번호 *@
        <div class="mb-3.5">
            <label class="block text-xs font-semibold text-slate mb-1.5">새 비밀번호</label>
            <input type="password" class="auth-input" placeholder="8자 이상"
                   @bind="mNewPassword" @bind:event="oninput" />
        </div>

        @* 비밀번호 확인 *@
        <div class="mb-3.5">
            <label class="block text-xs font-semibold text-slate mb-1.5">비밀번호 확인</label>
            <input type="password" class="auth-input" placeholder="비밀번호를 다시 입력하세요"
                   @bind="mConfirmPassword" @bind:event="oninput" />
        </div>

        @* 제출 *@
        <button class="btn-auth-submit" @onclick="HandleReset" disabled="@mIsLoading">
            @(mIsLoading ? "변경 중..." : "비밀번호 변경")
        </button>
    }

</AuthLayout>

@code {
    private string mNewPassword = string.Empty;
    private string mConfirmPassword = string.Empty;
    private string? mToken;
    private bool mIsLoading;
    private bool mReset;
    private string? mErrorMessage;

    protected override void OnInitialized()
    {
        var uri = new Uri(Navigation.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        mToken = query["token"];

        if (string.IsNullOrWhiteSpace(mToken))
        {
            mErrorMessage = "유효하지 않은 재설정 링크입니다.";
        }
    }

    private async Task HandleReset()
    {
        mErrorMessage = null;

        if (string.IsNullOrWhiteSpace(mToken))
        {
            mErrorMessage = "유효하지 않은 재설정 링크입니다.";
            return;
        }

        if (string.IsNullOrWhiteSpace(mNewPassword) || mNewPassword.Length < 8)
        {
            mErrorMessage = "비밀번호는 8자 이상이어야 합니다.";
            return;
        }

        if (mNewPassword != mConfirmPassword)
        {
            mErrorMessage = "비밀번호가 일치하지 않습니다.";
            return;
        }

        mIsLoading = true;

        try
        {
            var result = await AuthService.ResetPasswordAsync(mToken, mNewPassword);

            if (result.IsSuccess)
            {
                mReset = true;
            }
            else
            {
                mErrorMessage = result.Error ?? "비밀번호 변경에 실패했습니다.";
            }
        }
        catch
        {
            mErrorMessage = "서버와 통신할 수 없습니다.";
        }
        finally
        {
            mIsLoading = false;
        }
    }
}
